<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>U-Net++ Inference App</title>
  <style>
    :root {
      --bg: #f4f5f7;
      --card: #ffffff;
      --text: #0f172a;
      --muted: #64748b;
      --line: #dbe1ea;
      --accent: #0b5fff;
      --accent-hover: #0048d9;
      --disabled: #94a3b8;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Segoe UI", Arial, sans-serif;
      background: radial-gradient(circle at 10% 10%, #eaf1ff 0%, var(--bg) 40%, var(--bg) 100%);
      color: var(--text);
      min-height: 100vh;
      display: grid;
      place-items: center;
      padding: 20px;
    }
    .card {
      width: min(920px, 100%);
      border: 1px solid var(--line);
      border-radius: 14px;
      background: var(--card);
      padding: 20px;
      box-shadow: 0 10px 30px rgba(2, 6, 23, 0.08);
    }
    h1 {
      margin: 0 0 16px 0;
      font-size: 22px;
      letter-spacing: 0.2px;
    }
    .layout {
      display: grid;
      grid-template-columns: 320px 1fr;
      gap: 16px;
      align-items: start;
    }
    .panel {
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 14px;
      background: #fbfcff;
    }
    .preview {
      height: 320px;
      border: 2px dashed var(--line);
      border-radius: 10px;
      display: grid;
      place-items: center;
      background: #f8fafc;
      overflow: hidden;
    }
    .preview img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }
    .preview-text {
      color: var(--muted);
      font-size: 14px;
    }
    .actions {
      display: grid;
      gap: 10px;
    }
    button {
      appearance: none;
      border: 0;
      border-radius: 10px;
      font-size: 15px;
      font-weight: 600;
      color: #fff;
      background: var(--accent);
      padding: 12px 14px;
      cursor: pointer;
      transition: background 0.16s ease, transform 0.08s ease;
    }
    button:hover { background: var(--accent-hover); }
    button:active { transform: translateY(1px); }
    button:disabled {
      background: var(--disabled);
      cursor: not-allowed;
      transform: none;
    }
    .status {
      min-height: 22px;
      color: var(--muted);
      font-size: 14px;
      margin-top: 4px;
    }
    input[type="file"] { display: none; }
    @media (max-width: 860px) {
      .layout { grid-template-columns: 1fr; }
      .preview { height: 260px; }
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>U-Net++ Single Image Inference</h1>
    <div class="layout">
      <div class="panel">
        <div class="actions">
          <input id="fileInput" type="file" name="image" accept=".tif,.tiff,.png" />
          <button id="uploadBtn" type="button">Upload</button>
          <button id="inferBtn" type="button" disabled>Infer</button>
          <button id="downloadBtn" type="button" disabled>Download</button>
        </div>
        <div id="status" class="status"></div>
      </div>
      <div class="panel">
        <div id="preview" class="preview">
          <span class="preview-text">No image selected</span>
        </div>
      </div>
    </div>
  </div>
  <script>
    const fileInput = document.getElementById("fileInput");
    const uploadBtn = document.getElementById("uploadBtn");
    const inferBtn = document.getElementById("inferBtn");
    const downloadBtn = document.getElementById("downloadBtn");
    const preview = document.getElementById("preview");
    const status = document.getElementById("status");

    let selectedFile = null;
    let resultBlob = null;
    let resultFilename = "infer_result.zip";

    function setStatus(text) {
      status.textContent = text || "";
    }

    async function updatePreview(file) {
      preview.innerHTML = "";
      try {
        const form = new FormData();
        form.append("image", file);
        const res = await fetch("/preview", { method: "POST", body: form });
        if (!res.ok) {
          throw new Error("Preview failed");
        }
        const blob = await res.blob();
        const img = document.createElement("img");
        img.src = URL.createObjectURL(blob);
        img.onload = () => URL.revokeObjectURL(img.src);
        preview.appendChild(img);
      } catch (e) {
        const span = document.createElement("span");
        span.className = "preview-text";
        span.textContent = "Preview unavailable";
        preview.appendChild(span);
      }
    }

    uploadBtn.addEventListener("click", () => fileInput.click());

    fileInput.addEventListener("change", () => {
      const f = fileInput.files && fileInput.files[0];
      selectedFile = f || null;
      resultBlob = null;
      downloadBtn.disabled = true;
      inferBtn.disabled = !selectedFile;
      if (!selectedFile) {
        preview.innerHTML = '<span class="preview-text">No image selected</span>';
        setStatus("");
        return;
      }
      updatePreview(selectedFile);
      setStatus(selectedFile.name);
    });

    inferBtn.addEventListener("click", async () => {
      if (!selectedFile) return;
      inferBtn.disabled = true;
      downloadBtn.disabled = true;
      setStatus("Running inference...");
      const form = new FormData();
      form.append("image", selectedFile);
      try {
        const res = await fetch("/infer", { method: "POST", body: form });
        if (!res.ok) {
          let err = `Request failed (${res.status})`;
          const contentType = res.headers.get("content-type") || "";
          if (contentType.includes("application/json")) {
            const data = await res.json();
            if (data && data.error) err = data.error;
          } else {
            const text = await res.text();
            if (text) err = text.slice(0, 500);
          }
          throw new Error(err);
        }
        resultBlob = await res.blob();
        const disposition = res.headers.get("content-disposition") || "";
        const m = disposition.match(/filename=\"?([^\";]+)\"?/i);
        resultFilename = m && m[1] ? m[1] : "infer_result.zip";
        downloadBtn.disabled = false;
        setStatus("Inference completed");
      } catch (e) {
        setStatus(e.message || "Inference failed");
      } finally {
        inferBtn.disabled = false;
      }
    });

    downloadBtn.addEventListener("click", () => {
      if (!resultBlob) return;
      const url = URL.createObjectURL(resultBlob);
      const a = document.createElement("a");
      a.href = url;
      a.download = resultFilename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    });
  </script>
</body>
</html>
